# Архитектура Хранилищ

## Пример потока хранилищ

<figure><img src="../../.gitbook/assets/Picture 2.png" alt=""><figcaption></figcaption></figure>

1. Пользователь вносит 100 ETH в T-ETH-C (колл ETH).
2. В пятницу в 8 утра UTC хранилище закрывает раунд предыдущей недели и затем использует 100% своих средств для майнинга 100 otokens, которые являются ERC20-представлениями опционных контрактов. 100 ETH блокируются на неделю в Opyn.
3. Получив 100 отокенов, хранилище выставляет его на аукцион [Paradigm](https://www.paradigm.co/).
   * Зарегистрированные пользователи могут участвовать в торгах и делать ставки на отокены. Они платят премию за отокены в ETH. Paradigm может использовать различные виды аукционов для максимизации прибыли вкладчиков (например, [слепые аукционы](https://en.wikipedia.org/wiki/First-price\_sealed-bid\_auction))
   * По окончании аукциона хранилище получает 1 ETH в виде премии.
   * Все оставшиеся отокены, которые не были куплены, сжигаются, выкупая 1 отокен за 1 единицу залога в Opyn.
4. В следующую пятницу 8 утра UTC,
   * Если срок действия опционов истекает в деньгах, хранилище выводит из Opyn менее 100 ETH.
   * Если опционы заканчиваются не в деньгах, хранилище снимает ровно 100 ETH.
5. Предположим, что срок действия контракта закончился не в деньгах. Хранилище повторяет шаг 2 с 101 ETH (первоначальные 100 ETH + 1 ETH премии).

### Codebase

| Наименование                                                                                                                                       | Описание                                                                                                       |
| -------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------- |
| [libraries/Vault.sol](https://github.com/ribbon-finance/ribbon-v2/blob/master/contracts/libraries/Vault.sol)                                       | Содержит все структуры данных, общие для всех типов хранилищ                                                   |
| [libraries/VaultLifecycle.sol](https://github.com/ribbon-finance/ribbon-v2/blob/master/contracts/libraries/VaultLifecycle.sol)                     | Содержит всю логику, связанную с функционированием хранилища на еженедельной основе                            |
| [vaults/BaseVaults/base/RibbonVault.sol](https://github.com/ribbon-finance/ribbon-v2/blob/master/contracts/vaults/BaseVaults/base/RibbonVault.sol) | Содержит всю общую логику, такую как учет и обработка опционов, общую для RibbonThetaVault и RibbonDeltaVault. |
| [vaults/BaseVaults/RibbonThetaVault.sol](https://github.com/ribbon-finance/ribbon-v2/blob/master/contracts/vaults/BaseVaults/RibbonThetaVault.sol) | Контракт Хранилищ Theta, который создает короткую опционную позицию с Opyn на еженедельной основе              |

## Поток депозитов

ВАЖНО: это техническое объяснение, если вам нужна помощь в создании депозита, пожалуйста, обратитесь к `этой странице`!

<figure><img src="../../.gitbook/assets/Picture 3.png" alt=""><figcaption></figcaption></figure>

1. Пользователь вносит 1 ETH в хранилище Theta.
2. Сначала мы проверяем, есть ли у них существующий DepositReceipt от прошлого цикла. Используя сведения о раунде и сумме, мы обновляем поле UnredeemedShares. По сути, оно отслеживает, сколько долей принадлежит пользователю, но еще не выкуплено.

```
struct DepositReceipt {
	round
	amount
	unredeemedShares
}
```

4. Мы создаем DepositReceipt с новыми данными.
5. При rollToNextOption хранилище сминтит все доли, причитающиеся пользователям, по адресу address(this). При этом увеличивается vaultState.round.
6. Поскольку раунд завершен, акции хранилища пользователя должны отобразиться, вызвав RibbonVault.shares(account).

Конечный результат:

* Их акции появляются автоматически по завершении раунда.
* DepositReceipts используются для отслеживания всех невыкупленных акций пользователя. Это используется для снятия и погашения средств в будущем.

## Поток вывода средств

ВАЖНО: это техническое объяснение, если вам нужна помощь по выводу средств, пожалуйста, обратитесь к этой странице!

<figure><img src="../../.gitbook/assets/Picture 4.png" alt=""><figcaption></figcaption></figure>

Процесс вывода средств немного сложнее. У нас есть два типа вывода средств - стандартный и мгновенный.

### **Стандартное снятие средств**

* Вывод средств осуществляется с помощью функции initiateWithdraw, которая ставит акции в очередь на сжигание.
* Вывод средств завершается функцией completeWithdraw, которая сжигает акции и возвращает активы.
* Пользователи могут вызывать completeWithdraw только ПОСЛЕ пятницы 10 утра UTC. Например, пользователь вызывает
* Вывод средств накладывается друг на друга. Это означает, что если я сделаю initiateWithdraw(10) и снова initiateWithdraw(20), то к пятнице у меня будет снято в общей сложности 30 акций.

### **Мгновенное снятие средств**

* Мгновенное снятие доступно только для тех средств, которые были внесены в середине недели.
* Например, пользователь вносит 10 ETH в хранилище Theta в среду. Он может позвонить по номеру withdrawInstantly и вернуть до 10 ETH со среды по пятницу.

## Поток погашения акций

ВАЖНО: это техническое объяснение, если вам нужна помощь по выкупу акций хранилища, пожалуйста, обратитесь к этой странице!

<figure><img src="../../.gitbook/assets/Picture 5.png" alt=""><figcaption></figcaption></figure>

Как уже говорилось, когда пользователь вносит депозит в хранилище, хранилище выпускает и хранит акции пользователя на address(this). Это не идеально для протоколов или метахранилищ, которые хотят хранить свои акции. Вызвав функцию redeem или maxRedeem, контракты могут взять под охрану свои акции хранилища.

Поток выкупа акций также запускается неявно, когда пользователи вызывают `initiateWithdraw`.

## Контроль доступа

| Наименование  | Привилегии                                                                                                                                                                                                                                                  |
| ------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Владелец      | Владелец может задавать ключевые параметры хранилища, такие как feeRecipient, performanceFee, managementFee, лимит депозита и т. д. Некоторые функции в жизненном цикле хранилища ограничены только владельцем, например commitAndClose и rollToNextOption. |
| Администратор | Администратор может обновить адрес реализации прокси-сервера.                                                                                                                                                                                               |

Обе эти привилегированные роли используют мульти кошелек Gnosis Safe.
